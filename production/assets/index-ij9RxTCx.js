(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=window.Phaser,t=class{#counter=0;#key;constructor(e){this.#key=e}get(){return this.#counter++,`utkg`+this.#key+this.#counter}};function n(e,t,n){return t*(10+e-n)}function r(e,t,n){return t*(e-n/2)}function i(e){return Array(e.length).fill().map(t=>{let n=Math.floor(Math.random()*e.length);return e.splice(n,1)[0]})}function a(e,t,n){return n%=4,n==1?{column:-t,row:e}:n==2?{column:-e,row:-t}:n==3?{column:t,row:-e}:{row:t,column:e}}const o={RED:0,ORANGE:1,YELLOW:2,GREEN:3,SKY:4,BLUE:5,PURPLE:6,GREY:7,BLACK:8,VOID:9};var s=class e{static#ROT0SHAPE=[{size:3,origin:{x:1,y:1},map:[[1,1,0],[0,1,1],[0,0,0]]},{size:3,origin:{x:1,y:1},map:[[0,0,1],[1,1,1],[0,0,0]]},{size:2,origin:{x:0,y:1},map:[[1,1],[1,1]]},{size:3,origin:{x:1,y:1},map:[[0,1,1],[1,1,0],[0,0,0]]},{size:4,origin:{x:1,y:1},map:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]]},{size:3,origin:{x:1,y:1},map:[[1,0,0],[1,1,1],[0,0,0]]},{size:3,origin:{x:1,y:1},map:[[0,1,0],[1,1,1],[0,0,0]]}];static#rotateShape=function(e,t){let n=t/90%4,r=structuredClone(e);return e.map.forEach((t,i)=>t.forEach((t,o)=>{let s=(e.size-1)/2,c=a(o-s,i-s,n);c.column+=s,c.row+=s,r.map[c.row][c.column]=t})),r};#type;#rotation;#shape;constructor(t,n=0){this.#type=t,this.#rotation=n,this.#shape=e.#rotateShape(e.#ROT0SHAPE[t],n)}duplicate(t=void 0,n=void 0){return new e(t??this.#type,n??this.#rotation)}get type(){return this.#type}get shape(){return this.#shape}get rotation(){return this.#rotation}copyRotated(e){return this.duplicate(void 0,(this.#rotation+e)%360)}convertToTable(e={}){let t=[];this.#shape.map.forEach(n=>{let r=[];n.forEach(t=>{let n=new c(t,this.#type,{isActive:e.isActive});r.push(n)}),t.push(r)});let n={};return n.row=-this.#shape.origin.y,n.column=-this.#shape.origin.x,{table:t,topLeft:n}}},c=class{#isBlock;#isActive;#color;constructor(e,t=o.VOID,n={}){this.#isBlock=e,this.#isActive=n.isActive??!1,this.#color=t}get isBlock(){return this.#isBlock}get isActive(){return this.#isActive}get color(){return this.#color}};function l(e,t){return t.isBlock?t:e}var u=class{#rowCount;#columnCount;get rowCount(){return this.#rowCount}get columnCount(){return this.#columnCount}constructor(e=40,t=10){this.#rowCount=e,this.#columnCount=t}},d=class e{table;get rowCount(){return this.table.length}get columnCount(){return this.table[0].length}constructor(e,t){let n=e??new u;this.table=Array(n.rowCount).fill().map(()=>Array(n.columnCount).fill().map(t))}isCellPosOutOfTable(e,t){return e<0||this.rowCount<=e||t<0||this.columnCount<=t}duplicateTable(){let e=[];return this.table.forEach((t,n)=>{let r=[];t.forEach((e,t)=>{r.push(e)}),e.push(r)}),e}duplicate(){let t=new e(new u(this.rowCount,this.columnCount),()=>!1);return t.table=this.duplicateTable(),t}},f=class e extends d{constructor(e){super(e,()=>new c(!1))}compositeMinoTable(e,t,n){return e.forEach((e,r)=>{e.forEach((e,i)=>{let a=t+r,o=n+i;if(this.isCellPosOutOfTable(a,o))return;let s=l(this.table[a][o],e);this.table[a][o]=s})}),this}getCell(e,t){if(this.isCellPosOutOfTable(e,t))throw`Given cellPos is out of the range of the board`;return this.table[e][t]}doesMinoCollides(e,t,n){let r=!1;return e.shape.map.forEach((i,a)=>{i.forEach((i,o)=>{if(!i)return;let s=t+a-e.shape.origin.y,c=n+o-e.shape.origin.x;(this.isCellPosOutOfTable(s,c)||this.table[s][c].isBlock)&&(r=!0)})}),r}tryMoveMinoHorizontally(e,t,n,r){if(e==0)return 0;e=Math.floor(e);let i=e>0?1:-1,a=0;for(;e!=a&&!this.doesMinoCollides(t,n,r+a+i);)a+=i;return a}tryMoveMinoVertically(e,t,n,r){if(e==0)return 0;e=Math.floor(e);let i=e>0?1:-1,a=0;for(;e!=a&&!this.doesMinoCollides(t,n+a+i,r);)a+=i;return a}duplicate(){let t=new e(new u(this.rowCount,this.columnCount));return t.table=this.duplicateTable(),t}},p=class{#currentMino=new s(0);row=0;column=0;#isPlaced=!0;constructor(){}get mino(){return this.#currentMino}rotateMino(e){this.#currentMino=this.#currentMino.copyRotated(e)}place(){this.#isPlaced=!0}startNextMino(e){this.#isPlaced=!1,this.#currentMino=e,this.row=20,this.column=4}get isPlaced(){return this.#isPlaced}},m=class e{static TYPES={SEVEN:0};type;constructor(e){this.type=e}static#create_Seven(){return i(Array(7).fill(void 0).map((e,t)=>new s(t)))}createAndPushTo(t){e.#create_Seven().forEach(e=>t.push(e))}},h=class{#minoQueue;bag;constructor(e,t=[]){this.bag=e,this.#minoQueue=t,this.#genMinoQueueUntil100()}takeNextMino(){return this.#genMinoQueueUntil100(),this.#minoQueue.splice(0,1)[0]}#genMinoQueueUntil100(){for(;this.#minoQueue.length<100;)this.bag.createAndPushTo(this.#minoQueue)}},g=class{boardSize;cellBoard;currentMinoManager;minoQueueManager;boardControlState;constructor(e){for(let t of[`cellBoard`,`boardSize`,`currentMinoManager`,`minoQueueManager`,`boardControlState`])this[t]=e[t]}},_=class{static MOVE_LEFT=1;static MOVE_RIGHT=2;static START_SOFT_DROP=4;static STOP_SOFT_DROP=8;static HARD_DROP=16;static ROTATE_CLOCK_WISE=32;static ROTATE_COUNTER_CLOCK=64;static ROTATE_180=128;static START_MOVE_LEFT=65536;static STOP_MOVE_LEFT=131072;static START_MOVE_RIGHT=262144;static STOP_MOVE_RIGHT=524288;constructor(e=0){this.value=e}setFalseAll(){this.value=0}setTrue(e){this.value|=e}setFalse(e){this.value&=~e}get(e){return!!(this.value&e)}},v=_,y=class{fallingProgress=0;lockDownCount=0;softDrop=!1;constructor(){}};function b(){return{horizontalMinoMove:0,verticalMinoMove:0}}var x=class{#currentMinoManager;#cellBoard;#state;#minoQueueManager;constructor(e){this.#currentMinoManager=e.currentMinoManager,this.#cellBoard=e.cellBoard,this.#state=e.boardControlState,this.#minoQueueManager=e.minoQueueManager}update(e,t=.016667){let n=new _;n.value=e;let r=b();this.#currentMinoManager.isPlaced&&this.#update_newMino(),this.#update_processSoftDropInputs(n.value),this.#update_advanceFallingProgress(t),this.#update_rotateMino(n.value);let i=this.#update_gravityAndMove(n.value),a=this.#update_hardDrop(n.value);n.setFalseAll(),this.#update_lockdownReset(i);let o=this.#update_lockDown(t);return(a||o)&&this.#update_placeMino(),this.#currentMinoManager.isPlaced&&this.#update_newMino(),Object.assign(r,i),r}#update_lockdownReset(e){(e.horizontalMinoMove!=0||e.verticalMinoMove!=0)&&(this.#state.lockDownCount=0)}#update_lockDown(e){let t=this.#currentMinoManager;if(this.#cellBoard.doesMinoCollides(t.mino,t.row+1,t.column)){if(this.#state.lockDownCount+=e,this.#state.lockDownCount>.5)return!0}else this.#state.lockDownCount=0;return!1}#update_processSoftDropInputs(e){e&v.START_SOFT_DROP&&(this.#state.softDrop=!0),e&v.STOP_SOFT_DROP&&(this.#state.softDrop=!1)}#update_advanceFallingProgress(e){let t=this.#currentMinoManager;this.#cellBoard.doesMinoCollides(t.mino,t.row+1,t.column)?this.#state.fallingProgress=0:this.#state.fallingProgress+=e*60*.02*(this.#state.softDrop?20:1)}#update_gravityAndMove(e){let t=0,n=0;do{{let n=!!(e&v.MOVE_LEFT),r=!!(e&v.MOVE_RIGHT),i=-1*n+1*r,a=this.#moveMinoHorizontally(i);t+=a}if(this.#state.fallingProgress>=1){this.#state.fallingProgress--;let e=this.#moveMinoVertically(1);n+=e}}while(this.#state.fallingProgress>=1);return{horizontalMinoMove:t,verticalMinoMove:n}}#update_hardDrop(e){return e&v.HARD_DROP?(this.#moveMinoVertically(99),!0):!1}#update_rotateMino(e){let t=this.#currentMinoManager,n=0;if(e&v.ROTATE_CLOCK_WISE)n=90;else if(e&v.ROTATE_COUNTER_CLOCK)n=270;else return;let r=t.mino.copyRotated(n);this.#cellBoard.doesMinoCollides(r,t.row,t.column)||(t.rotateMino(n),this.#state.lockDownCount=0)}#update_placeMino(){let e=this.#currentMinoManager,{table:t,topLeft:n}=e.mino.convertToTable(),r=e.row+n.row,i=e.column+n.column;this.#cellBoard.compositeMinoTable(t,r,i),e.place()}#update_newMino(){let e=this.#minoQueueManager.takeNextMino();this.#currentMinoManager.startNextMino(e),this.#state.fallingProgress=0,this.#state.lockDownCount=0}#moveMinoVertically(e){let t=this.#currentMinoManager,n=this.#currentMinoManager.mino,r=this.#cellBoard.tryMoveMinoVertically(e,n,t.row,t.column);return t.row+=r,r}#moveMinoHorizontally(e){let t=this.#currentMinoManager,n=this.#currentMinoManager.mino,r=this.#cellBoard.tryMoveMinoHorizontally(e,n,t.row,t.column);return t.column+=r,r}},S=class{#leftIsStrong=!1;constructor(){}setNewPlayerInput(e){let t=new _(e);t.get(v.START_MOVE_LEFT)&&(this.#leftIsStrong=!0),t.get(v.START_MOVE_RIGHT)&&(this.#leftIsStrong=!1)}getLeftIsStrong(){return this.#leftIsStrong}judgeToFlag(e,t){return e&&t?this.#leftIsStrong?v.MOVE_LEFT:v.MOVE_RIGHT:v.MOVE_LEFT*+e+v.MOVE_RIGHT*+t}},C=class{#controlOrder;leftMoveDown=!1;rightMoveDown=!1;DASTimerF=12;ARRTimerF=0;#horizontalJudge;autoShiftEnabled(){return this.DASTimerF<=0&&(this.leftMoveDown||this.rightMoveDown)}constructor(){this.#controlOrder=new _,this.#horizontalJudge=new S}#resetDAS(){this.DASTimerF=12}setNewPlayerInput(e){this.#controlOrder.setTrue(e),this.#setNewPlayerInput_receiveHorizontal(e),this.#horizontalJudge.setNewPlayerInput(e)}#setNewPlayerInput_receiveHorizontal(e){let t=new _(e);t.get(v.START_MOVE_LEFT)&&(this.leftMoveDown=!0),t.get(v.STOP_MOVE_LEFT)&&(this.leftMoveDown=!1),t.get(v.START_MOVE_RIGHT)&&(this.rightMoveDown=!0),t.get(v.STOP_MOVE_RIGHT)&&(this.rightMoveDown=!1),t.get(v.START_MOVE_LEFT+v.START_MOVE_RIGHT)&&this.#resetDAS()}advanceTime(e){--this.ARRTimerF,(this.leftMoveDown||this.rightMoveDown)&&--this.DASTimerF}receiveControlResult(e){e.horizontalMinoMove&&(this.ARRTimerF=1)}provideControlOrder(){this.#provide_doHorizontalControl();let e=new _(this.#controlOrder.value);return this.#controlOrder.setFalseAll(),e}#provide_doHorizontalControl(){let e=this.#controlOrder.get(v.START_MOVE_LEFT|v.START_MOVE_RIGHT);if(this.ARRTimerF<=0&&(e||this.autoShiftEnabled())){let e=this.#horizontalJudge.judgeToFlag(this.leftMoveDown,this.rightMoveDown);this.#controlOrder.setTrue(e)}}},w=class{#boardController;#controlOrderProvider;#lastBoardControlResult;constructor(e,t){this.#controlOrderProvider=t.controlOrderProvider,this.#boardController=t.boardController,this.#lastBoardControlResult=new b}update(e){let t=this.#controlOrderProvider.provideControlOrder();this.#lastBoardControlResult=this.#boardController.update(t.value,e),this.#controlOrderProvider.receiveControlResult(this.#lastBoardControlResult),this.#controlOrderProvider.advanceTime(e)}};const T=[`red`,`orange`,`yellow`,`green`,`sky`,`blue`,`purple`,`grey`,`black`],E=[`nine`],D=[`default`,`tikin`],O=[...D,...E],k=[`n`,`a`];function A(e){return e.skin??=`default`,typeof e.color==`number`&&(e.color=Math.floor(e.color)%T.length,e.color=T[e.color]),e.color??=`red`,e.gobi??=`n`,e.isActive??=!1,e.gobi===`a`&&(e.isActive=!0),e}function j(e){let t=`n`;return e.isActive&&(t=`a`),t}function M(e){let t=A(e);return`cell_${t.skin}_${t.color}_${j(t)}`}function N(e){let t=A(e);return`/image/cell/${t.skin}/${t.color}_${j(t)}.png`}function P(e){return`/image/cellsheet/${e}.png`}function F(e){let t=[];for(let n=0;n<7;n++){let r=T[n];k.forEach(n=>{let i={skin:e,color:r,gobi:n};t.push(i)})}return t}function I(e){return e.skin=`skin`,L(A)}function L(e){return`cellsheet_${e}`}var R=new t(`boardview`),z=class{#settings={skin:`default`};constructor(e={}){Object.assign(this.#settings,e)}get(e){return this.#settings[e]}};e.GameObjects.Image;var B=class{#image;#cellWidth;#cellBoard;#scene;#currentMinoManager;#boardContainer;#boardViewSettings;get#boardWidth(){return this.#cellWidth*this.#cellBoard.rowCount}set x(e){this.#image.x=e}set y(e){this.#image.y=e}constructor(e,t,n,r){this.#scene=e,this.#cellWidth=t,this.#cellBoard=n.cellBoard,this.#currentMinoManager=n.currentMinoManager,this.#boardContainer=r.boardContainer,this.#boardViewSettings=r.boardViewSettings,this.#init()}#init(){let e=R.get();this.#scene.textures.createCanvas(e,this.#boardWidth*1.25,this.#boardWidth*2.25),this.#image=this.#scene.add.image(0,0,e),this.#boardContainer.add(this.#image)}update(){(()=>{if(this.#currentMinoManager.isPlaced)return this.#cellBoard.duplicate();let{table:e,topLeft:t}=this.#currentMinoManager.mino.convertToTable({isActive:!0});return this.#cellBoard.duplicate().compositeMinoTable(e,this.#currentMinoManager.row+t.row,this.#currentMinoManager.column+t.column)})()}},V=new t(`boarddeco`),H=class e{static#strokeGrid(e,t,i,a){e.strokeStyle=`#323232ff`,e.lineWidth=t/10;for(let o=0;o<=i;o++){let s=n(o,t,i);e.beginPath(),e.moveTo(r(0,t,a),s),e.lineTo(r(a,t,a),s),e.stroke()}for(let o=0;o<=a;o++){let s=r(o,t,a);e.beginPath(),e.moveTo(s,n(0,t,i)),e.lineTo(s,n(i,t,i)),e.stroke()}e.beginPath()}static#fillBackground(e,t,i,a){e.fillStyle=`#000`,e.fillRect(r(0,t,a),n(0,t,i),t*a,t*i)}#boardSize;#cellWidth;#image;#scene;#boardContainer;get#boardWidth(){return this.#cellWidth*this.#boardSize.rowCount}set x(e){this.#image.x=e}set y(e){this.#image.y=e}constructor(e,t,n,r){this.#scene=e,this.#cellWidth=t,this.#boardSize=n.boardSize,this.#boardContainer=r,this.#init()}#init(){let e=V.get();this.#scene.textures.createCanvas(e,this.#boardWidth*1.25,this.#boardWidth*2.25),this.#image=this.#scene.add.image(0,0,e),this.#boardContainer.add(this.#image)}update(){let t=this.#image.texture.canvas,n=t.getContext(`2d`);n.clearRect(-10,-10,1e4,1e5),n.save(),n.translate(t.width/2,t.height/2),e.#fillBackground(n,this.#cellWidth,20,this.#boardSize.columnCount),e.#strokeGrid(n,this.#cellWidth,20,this.#boardSize.columnCount),n.restore(),this.#image.texture.refresh()}},U=class{#boardView;#boardDeco;#boardContainer;set x(e){this.#boardContainer.x=e}set y(e){this.#boardContainer.y=e}constructor(e,t){this.#boardContainer=e.add.container(),this.#boardDeco=new H(e,30,t,this.#boardContainer),this.#boardView=new B(e,30,t,{boardContainer:this.#boardContainer,boardViewSettings:new z({})})}update(e){this.#boardDeco.update(),this.#boardView.update()}},W=class{static create(e){let t=new u(40,10),n=new p,r=new f(t);console.log(r);let i=new h(new m(m.TYPES.SEVEN)),a=new y,o=new g({cellBoard:r,boardSize:t,currentMinoManager:n,minoQueueManager:i,boardControlState:a}),s=new C,c=new x(o),l=new w(o,{boardController:c,controlOrderProvider:s});console.log(o);let d=new U(e,o);return d.x=e.width/2,d.y=e.height/2,{gameController:l,gameContext:o,viewController:d,controlOrderProvider:s}}};function G(e){let t=0;t+=T.indexOf(e.color);let n=0;return e.isActive&&(n+=1),{column:t,row:n}}function K(e,t){let n=G(t);return{x:n.column*e,y:n.row*e}}function q(e){return e*T.length}function J(e){return e*k.length}var Y=class{constructor(e,t){let n=L(t);if(D.includes(t)){if(this.texture=e.textures.createCanvas(n,q(30),J(30)),this.texture===null)throw`wtf`;this.texture.cellTextureParent=this,this.skin=t,this.scene=e,this.draw(30),this.texture.refresh()}else if(E.includes(t))this.texture=e.textures.get(L(t));else throw`no such skin`}draw(e){F(this.skin).map(e=>A(e)).forEach(t=>{this.createAndDrawFrame(e,t)})}createAndDrawFrame(e,t){let n=this.texture.canvas.getContext(`2d`),r=K(e,t),i=M(t),a=this.scene.textures.get(i).getSourceImage();n.drawImage(a,r.x,r.y,e,e);let o=I(t);this.texture.add(o,0,r.x,r.y,e,e)}},X=class extends e.Scene{width;height;#gameController;#viewController;#controlOrderProvider;constructor(){super({key:`play`})}preload(){D.forEach(e=>{F(e).forEach(e=>{let t=A(e),n=M(t),r=N(t);this.load.image(n,r)})}),E.forEach(e=>{let t=L(e),n=P(e);this.load.image(t,n)})}create(){O.forEach(e=>{new Y(this,e)}),document.body.appendChild(this.textures.get(L(`nine`)).getSourceImage()),this.width=this.game.canvas.width,this.height=this.game.canvas.height;let e=W.create(this);this.#gameController=e.gameController,this.#viewController=e.viewController,this.#controlOrderProvider=e.controlOrderProvider,this.input.keyboard.on(`keydown`,e=>{if(e.repeat){e.preventDefault();return}let t={ArrowLeft:_.START_MOVE_LEFT,ArrowRight:_.START_MOVE_RIGHT,ArrowDown:_.START_SOFT_DROP,KeyX:_.ROTATE_CLOCK_WISE,KeyZ:_.ROTATE_COUNTER_CLOCK,Space:_.HARD_DROP};Object.keys(t).includes(e.code)&&(e.preventDefault(),this.#controlOrderProvider.setNewPlayerInput(t[e.code]))}),this.input.keyboard.on(`keyup`,e=>{let t={ArrowLeft:_.STOP_MOVE_LEFT,ArrowRight:_.STOP_MOVE_RIGHT,ArrowDown:_.STOP_SOFT_DROP};Object.keys(t).includes(e.code)&&(e.preventDefault(),this.#controlOrderProvider.setNewPlayerInput(t[e.code]))})}update(e,t){let n=t/1e3;this.#gameController.update(n),this.#viewController.update(n)}};addEventListener(`DOMContentLoaded`,()=>{let t={width:1200,height:720,scale:{mode:e.Scale.NONE,autoCenter:e.Scale.CENTER_BOTH},backgroundColor:`#ddd`,parent:`game-container`,scene:X};new e.Game(t)});